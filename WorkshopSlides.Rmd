---
title: "Shiny Workshop"
author: "David Mawdsley, Louise Lever"
date: "RSE 2018 Conference<p><img src='http://assets.manchester.ac.uk/logos/hi-res/TAB_UNI_MAIN_logo/White_backgrounds/TAB_col_white_background.png' style='border:0px solid black' width='50%'></p>"
output: 
  revealjs::revealjs_presentation:
    transition: fade
    theme: solarize
    fig_height: 6
    self_contained: true
    reveal_options:
      controls: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(igraph)
gapminder <- readRDS("coursematerial/gapminder.rds")
source("coursematerial/plottingFunctions.R")
```

## Shiny for R

- Introduction
- Workshop format
    - Why (not?) use Shiny
    - Gapminder data
    - Writing Shiny apps
    - Deploying Shiny apps
  
## Why use Shiny

- Fast to develop
- Use R's libraries easily

## Why not use Shiny

- Does not scale very well
- Expensive pro version of server
- 

## Gapminder data

- Background to gapminder
- Factfullness

<iframe width="560" height="315" src="http://www.youtube.com/embed/jbkSRLYSojo?start=75" frameborder="0" allowfullscreen></iframe>

## Static visualisation

```{r, echo = FALSE}
gapminder %>% 
  filter(year == 1817) %>% 
  produceGapminderPlot()
```

## Static visualisation

```{r}
gapminder %>% 
  filter(year == 1917) %>% 
  produceGapminderPlot()
```

## Static visualisation

```{r}
gapminder %>% 
  filter(year == 2017) %>% 
  produceGapminderPlot()

```

## Static visualisation

```{r}
historicData <- gapminder %>% 
  filter(country == "United Kingdom")

gapminder %>% 
  filter(year == 2017) %>% 
  produceGapminderPlot(makeSemiTransparent = TRUE) %>% 
  addHistoricPlot(historicData, 2017)
```

## Workshop aims

- To use Shiny to make an interactive version of the plot
    - Select / animate the year
    - Only plot data for selected continents
    - Customise the look of our app
    - Identify a country by selecting it
    - Show "trajectory" for selected country

## Getting started

* Run the Docker container we will be using:

```
docker run -d --name rstudio -p 8787:8787 -p 3838:3838 \
-v "$(pwd)/coursematerial:/home/rstudio/coursematerial" \
-e USERID=ID  mawds/rstudio
```
* Connect to http://localhost:8787 using Chromium. 

* username: rstudio password: rstudio

* `coursematerial` contains the data and plotting functions we will use.

* `codeExample.R` shows how to use the plotting functions.




## Anatomy of a Shiny App - user interface

```
ui <- fluidPage(
    
    # Application title
    titlePanel("Old Faithful Geyser Data"),
    
    # Sidebar with a slider input for number of bins 
    sidebarLayout(
        sidebarPanel(
            sliderInput("bins", ...
        ),
        
        
        mainPanel(
           plotOutput("distPlot")
        )
    )
)
```

`input$bins` is a source

`output$distPlot` is an endpoint

## Anatomy of a Shiny App - server
```
server <- function(input, output) {
    
    output$distPlot <- renderPlot({
        # generate bins based on input$bins from ui.R
        x    <- faithful[, 2] 
        bins <- seq(min(x), max(x), length.out = input$bins + 1)
        
        # draw the histogram with the specified number of bins
        hist(x, breaks = bins, col = 'darkgray', border = 'white')
    })
}

```

## Exercise 

* Create and save a new Shiny app (this will be pre-filled with the example code)
* Check this works
* Modify the app to load the tidyverse library, gapminder data and `plottingFunctions.R`

* Modify the app to plot a histogram of all the populations in the gapminder data


## Exercise: Workshop aims

- To use Shiny to make an interactive version of the plot
    - Select / animate the year
    - ~~Only plot data for selected continents~~
    - ~~Customise the look of our app~~
    - ~~Identify a country by selecting it~~
    - ~~Show "trajectory" for selected country~~
    
    

- Create a new `sliderInput` with `inputId` "year" to select a year.
- use the `animate` option to allow this to run through the years
    
- Using the code in `codeExample.R` as a starting point,  plot the data for the selected year in the app

## More widgets

- Many common widget types are built into Shiny see:
    https://shiny.rstudio.com/gallery/widget-gallery.html 
- Can be extended using additional packages (https://github.com/dreamRs/shinyWidgets)
- or by writing your own.
  

## Exercise: Workshop aims

- To use Shiny to make an interactive version of the plot
    - ~~Select / animate the year~~
    - Only plot data for selected continents
    - ~~Customise the look of our app~~
    - ~~Identify a country by selecting it~~
    - ~~Show "trajectory" for selected country~~

- Add another widget to select continents, and modify your server function to filter the data so that only the selected continents are shown.

## Cutomising how our app looks

- The `shinythemes` package lets us select readymade themes for our app
- Can write our own css for more control
- `shinythemes::themeSelector()` widget lets us interactively exeriment with themes
- Use the option `theme = shinytheme("themename")` on your user interface function (`fluidPage`) in our example
    
## App layout

- The default apps `sidebarLayout()` is a good starting point.
- The `fluidPage()` layout gives us more control.

```{r, echo = TRUE,  eval = FALSE}
ui <- fluidPage(
  titlePanel("Gapminder Analysis"), # Will cover whole width
  plotOutput("mainPlot", click = "mainPlotClick"), # Ditto
  fluidRow( 
    column(6, # column width
           sliderInput(inputId = "year", # Things to include in the column
                       ....)
           
    ),
    column(6, # Next column
           checkboxGroupInput("continent", # Things to include in second column
                              ....)
    )
  )
)
```

- The widths of each row of columns should sum to 12
- Columns can be nested

## Making the graph interactive

- Click on a country and see its name

- `renderPlot("plotname", click = "clickName")` will output information about mouse clicks to the server.

- Demo this

## Working with click data

- Click output is in mapped coordinates
  - (this works with ggplot2 and base graphs, but not lattice graphs)
- Need to map coordinates to an entry in the data - `nearPoints()` does this for us
- But we only care about the points we can see.  At the moment these are filtered in our `renderPlot()` function
  - Should avoid code repetition
  
## Reactive data

```{r}
edges <- tribble(~v1, ~v2,
                 "year", "plotData",
                 "continents", "plotData",
                 "plotData", "plot",
                 "plotData", "activeCountry",
                 "click", "activeCountry",
                 "activeCountry", "countryText")



g <- graph_from_edgelist(as.matrix(edges))
set_vertex_attr(g, "color", value ="red", index = c("year", "continents", "click")) %>% 
  set_vertex_attr( "color", value ="green", index = c("plotData", "activeCountry")) %>% 
  set_vertex_attr("color", value ="yellow", index = c("plot", "countryText")) %>% 
  plot()

```



    
## Deploying Shiny apps

- Probably won't do this bit interactively.
