---
title: "Shiny Workshop"
author: "David Mawdsley, Louise Lever"
date: "RSE 2018 Conference<p><img src='http://assets.manchester.ac.uk/logos/hi-res/TAB_UNI_MAIN_logo/White_backgrounds/TAB_col_white_background.png' style='border:0px solid black' width='50%'></p>"
output: 
  revealjs::revealjs_presentation:
    transition: fade
    theme: solarize
    fig_height: 6
    self_contained: true
    reveal_options:
      controls: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(igraph)
gapminder <- readRDS("coursematerial/gapminder.rds")
source("coursematerial/plottingFunctions.R")
```

## Shiny for R

- Introduction to Shiny
- Gapminder data
- Running example: visualising the gapminder data
- Deploying Shiny apps

## Introduction to Shiny
- Interactive visualisation using R
  -[Shiny gallery](https://shiny.rstudio.com/gallery/)
  
## Why (not?) use Shiny

- Fast to develop
- Use R's libraries easily
- Many built in widgets
    - And packages for others
<p>
- Awkward to scale
- Non-free pro version needed for some features

## [Gapminder](https://www.gapminder.org) 

[![Gapminder Video](http://img.youtube.com/vi/jbkSRLYSojo/0.jpg)](https://youtu.be/jbkSRLYSojo?t=90)

## Static visualisation

```{r}
gapminder %>% 
  filter(year == 1817) %>% 
  produceGapminderPlot()
```

## Static visualisation

```{r}
gapminder %>% 
  filter(year == 1917) %>% 
  produceGapminderPlot()
```

## Static visualisation

```{r}
gapminder %>% 
  filter(year == 2017) %>% 
  produceGapminderPlot()

```

## Static visualisation

```{r}
historicData <- gapminder %>% 
  filter(country == "United Kingdom")

gapminder %>% 
  filter(year == 2017) %>% 
  produceGapminderPlot(makeSemiTransparent = TRUE) %>% 
  addHistoricPlot(historicData)
```

## Workshop aims

- To use Shiny to make an interactive version of the plot
    - Select / animate the year
    - Only plot data for selected continents
    - Identify a country by selecting it
    - Show "trajectory" for selected country

## Getting started

* Run rstudio:

```
rstudio
```

* `coursematerial` contains the data and plotting functions we will use.

* `codeExample.R` shows how to use the plotting functions.

##

```{r, echo = TRUE, fig.height=4, fig.width=5}
gapminder %>% 
  filter(year == 2017) %>% 
  produceGapminderPlot()

```


##

```{r, echo = TRUE, fig.height=4, fig.width=5}
historicData <- gapminder %>% 
  filter(country == "United Kingdom")

gapminder %>% 
  filter(year == 2017) %>% 
  produceGapminderPlot(makeSemiTransparent = TRUE) %>% 
  addHistoricPlot(historicData)
```

## Interactive exercises

* The `coursematerial` folder is a git repository
* Solutions are stored as tagged commits for code in the `worked_example` directory
    * e.g [git:01_helloworld]() 
    * Link takes you to github's commit page
    * Checkout versions with `git checkout helloworld`

* Make your own Shiny app in another directory

## Getting started

* Make a new Shiny app and check it works: [git:01_helloworld]()
    * File, New File, Shiny Web App
    * Name: gapminder
    * Single file
    * Create within directory: `~/mawdsley`
  
* Run App using toolbar or <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Enter</kbd>

## Anatomy of a Shiny App - user interface

```
ui <- fluidPage(
    
    # Application title
    titlePanel("Old Faithful Geyser Data"),
    
    # Sidebar with a slider input for number of bins 
    sidebarLayout(
        sidebarPanel(
            sliderInput("bins", ...
        ),
        
        
        mainPanel(
           plotOutput("distPlot")
        )
    )
)
```

`input$bins` is a source

`output$distPlot` is an endpoint

## Anatomy of a Shiny App - server
```
server <- function(input, output) {
    
    output$distPlot <- renderPlot({
        # generate bins based on input$bins from ui.R
        x    <- faithful[, 2] 
        bins <- seq(min(x), max(x), length.out = input$bins + 1)
        
        # draw the histogram with the specified number of bins
        hist(x, breaks = bins, col = 'darkgray', border = 'white')
    })
}

```

## Exercise - getting ready for the rest of the course.

* Modify the app to load the ggplot2 and dplyr libraries, gapminder data and `plottingFunctions.R` 
* Modify the app to show a (non interactive) gapminder plot instead of the histogram.
    * `codeExample.R` may be useful.
    * (Don't worry about changing the "bins" slider - we'll do that next)
* Change the title of the app to something sensible

[git:02_loadresources]()

## Exercise

- To use Shiny to make an interactive version of the plot
    - **Select / animate the year**
    - Only plot data for selected continents
    - Identify a country by selecting it
    - Show "trajectory" for selected country


## Exercise

- Modify the `sliderInput`; change  `inputId` to  "year" and use this to select a year. [git:03_yearslider]()
    - The `sep` option will let you deal with the ","s in the years.
    - `step` contols the interval between selectable values.
- Use the `animate` option to allow this to run through the years [git:04_animate]()
    - You may wish to explore `animationOptions()` to control the animation speed
    
- Use the slider to make the graph interactive.
    - `input$year` will contain the value of the year
[git:05_baseplot]()


## More widgets

- Many common widget types are built into Shiny see:
    https://shiny.rstudio.com/gallery/widget-gallery.html 
- Can be extended using additional packages (e.g. https://github.com/dreamRs/shinyWidgets)
- [or by writing your own](https://shiny.rstudio.com/articles/building-inputs.html).
  

## Exercise

- To use Shiny to make an interactive version of the plot
    - ~~Select / animate the year~~
    - **Only plot data for selected continents**
    - Identify a country by selecting it
    - Show "trajectory" for selected country

## Exercise

- [The Shiny Widget Gallery](https://shiny.rstudio.com/gallery/widget-gallery.html) lists built in widgets
- Use a `checkboxGroupInput` to select continents. [git:06_continentUI]()
    - `levels(gapminder$continent)` will return a vector of the continents in the data.
    - The `selected` option controls which elements are selected at the start

- Modify your server function to filter the data so that only the selected continents are shown. [git:07_continent]()

## Making the graph interactive
- To use Shiny to make an interactive version of the plot
    - ~~Select / animate the year~~
    - ~~Only plot data for selected continents~~
    - **Identify a country by selecting it**
    - Show "trajectory" for selected country

## Demo:

- `plotOutput("plotname", click = "clickName")` will output information about mouse clicks within a plot to the server.
- To see the output of this we need to use `renderPrint()` to capture the output (cf. `renderPlot()`)
- Which we then need to display in our user interface using `textOutput()` (cf. `plotOutput()`)
[git:08_clickdata]()

## Working with click data

- Click output is in mapped coordinates (dependent on graph package)
- Need to map coordinates to an entry in the data - `nearPoints()` does this for us
  - We can look at the output of `nearPoints()` (optionally using `renderTable()` and `tableOutput()` to format things nicely)
[git:09_nearpoints]()

## Working with click data

2 problems:

1. `nearPoints()` is using _all_ the data, not just the current year
    - Should be the data displayed on the graph
2. As soon as the graph changes...the click event is lost
    - Year advances
    - Graph resizes

## Solving problem 1

- We make the filtered data _reactive_   [git:10_reactivedata]()
    - Data which changes over time
    - We need the active data in two places - for the graph and as input to `nearpoints()`.

## Reactive data

```{r}
edges <- tribble(~v1, ~v2,
                 "year", "plotData",
                 "continent", "plotData",
                 "plotData", "gapminderPlot",
                 "plotClick", "showClick",
                 "plotData", "showClick")



g <- graph_from_edgelist(as.matrix(edges)) %>% 
set_vertex_attr( "color", value = "red", index = c("year", "continent", "plotClick")) %>% 
  set_vertex_attr( "color", value = "green", index = c("plotData")) %>% 
  set_vertex_attr("color", value = "yellow", index = c("gapminderPlot", "showClick")) 

layout <- structure(c(148, 200, 281, 121, 400, 287, 386, 200, 386, 4, 382, 
0), .Dim = c(6L, 2L))

plot(g, layout = layout)

```

## Solving problem 2

- The `plotClick` becomes invalid every time the graph updates
- We use `observeEvent()` to observe when a click happens, and store the click information
- And only then do we update the active country [git:11_showselected]()

##

```{r}
edges2 <- tribble(~v1, ~v2,
                 "year", "plotData",
                 "continent", "plotData",
                 "year", "historicData",
                 "activeCountry", "historicData",
                 "plotData", "gapminderPlot",
                  "historicData", "gapminderPlot",
                 "activeCountry", "showClick",
                 "plotClick", "activeCountry"
                 )



g2 <- graph_from_edgelist(as.matrix(edges2)) %>% 
set_vertex_attr( "color", value = "red", index = c("year", "continent", "plotClick")) %>% 
  set_vertex_attr( "color", value = "green", index = c("plotData", "historicData", "activeCountry")) %>% 
  set_vertex_attr("color", value = "yellow", index = c("gapminderPlot", "showClick")) 

layout2 <- structure(c(83, 117, 244, 247, 353, 77, 378, 381, 364, 170, 368, 
171, 246, 0, 5, 371), .Dim = c(8L, 2L))

g3 <- g2 %>% delete_vertices("historicData")
layout3 <- layout2[!(V(g2)$name == "historicData"),]

plot(g3, layout = layout3)
```

## Exercise: Workshop aims

- To use Shiny to make an interactive version of the plot
    - ~~Select / animate the year~~
    - ~~Only plot data for selected continents~~
    - ~~Identify a country by selecting it~~
    - **Show "trajectory" for selected country**
    
```{r, fig.height=3, fig.width=5}
historicData <- gapminder %>% 
  filter(country == "United Kingdom")

gapminder %>% 
  filter(year == 2017) %>% 
  produceGapminderPlot(makeSemiTransparent = TRUE) %>% 
  addHistoricPlot(historicData)
```


##

- We need to make another reactive data-set containing the historic data for the selected country
- We need to add this to the plot, if a country is selected.

[git:12_showtrace]()

##
```{r}
g2 %>% 
  # add_edges(c("historicData", "gapminderPlot",
  #                  "year", "gapminderPlot")) %>% 
  plot(layout = layout2)
```


## Deploying Shiny apps

- Run from R(Studio)

- https://shinyapps.io 
    - Easy deployment from RStudio
    - Various pricing tiers (inc. free)
    - https://mawds.shinyapps.io/worked_example/
- Shiny server
    - Free and commercial versions
    - Authentication requires commercial version
    
## Summary

- Define the UI and server functions
- Reactive programming handles the depencencies between elements
- Deploy apps using shinyapps.io or to a Shiny Server


## Extra Slides

## Cutomising how our app looks

- The `shinythemes` package lets us select readymade themes for our app
- Can write our own css for more control
- `shinythemes::themeSelector()` widget lets us interactively exeriment with themes [git:13_themeselector]()
- Use the option `theme = shinytheme("themename")` on your user interface function (`fluidPage`) in our example [git:14_changetheme]()

    
## App layout

- The default apps `sidebarLayout()` is a good starting point.
- The `fluidPage()` layout gives us more control.

```{r, echo = TRUE,  eval = FALSE}
ui <- fluidPage(
  titlePanel("Gapminder visualisation"), # Will cover whole width
  plotOutput("gapminderPlot", click = "plotClick"), # Ditto
  fluidRow( 
    column(6, # column width
           sliderInput(inputId = "year", ....) # Things to include in the column
    ),
    column(6, # Next column
           checkboxGroupInput("continent", ....)# Things to include in second column
    )
  )
)
```

- The widths of each row of columns should sum to 12 [git:15_fluidpage]()

