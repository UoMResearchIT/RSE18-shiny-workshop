---
title: "Shiny Workshop"
author: "David Mawdsley, Louise Lever"
date: "RSE 2018 Conference<p><img src='http://assets.manchester.ac.uk/logos/hi-res/TAB_UNI_MAIN_logo/White_backgrounds/TAB_col_white_background.png' style='border:0px solid black' width='50%'></p>"
output: 
  revealjs::revealjs_presentation:
    transition: fade
    theme: solarize
    fig_height: 6
    self_contained: true
    reveal_options:
      controls: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(igraph)
gapminder <- readRDS("coursematerial/gapminder.rds")
source("coursematerial/plottingFunctions.R")
```

## Shiny for R

- Introduction
- Workshop format
    - Why (not?) use Shiny
    - Gapminder data
    - Writing Shiny apps
    - Deploying Shiny apps
  
## Why (not?) use Shiny

- Fast to develop
- Use R's libraries easily
- Many built in widgets
    - And packages for others
<p>
- Awkward to scale
- Non-free pro version needed for some features

## Gapminder data

- Background to gapminder
- Factfullness

<iframe width="560" height="315" src="http://www.youtube.com/embed/jbkSRLYSojo?start=75" frameborder="0" allowfullscreen></iframe>

## Static visualisation

```{r, echo = FALSE}
gapminder %>% 
  filter(year == 1817) %>% 
  produceGapminderPlot()
```

## Static visualisation

```{r}
gapminder %>% 
  filter(year == 1917) %>% 
  produceGapminderPlot()
```

## Static visualisation

```{r}
gapminder %>% 
  filter(year == 2017) %>% 
  produceGapminderPlot()

```

## Static visualisation

```{r}
historicData <- gapminder %>% 
  filter(country == "United Kingdom")

gapminder %>% 
  filter(year == 2017) %>% 
  produceGapminderPlot(makeSemiTransparent = TRUE) %>% 
  addHistoricPlot(historicData, 2017)
```

## Workshop aims

- To use Shiny to make an interactive version of the plot
    - Select / animate the year
    - Only plot data for selected continents
    - Customise the look of our app
    - Identify a country by selecting it
    - Show "trajectory" for selected country

## Getting started

* Run the Docker container we will be using:

```
docker run -d --name rstudio -p 8787:8787 -p 3838:3838 \
-v "$(pwd)/coursematerial:/home/rstudio/coursematerial" \
-e USERID=ID  mawds/rstudio
```
* Connect to http://localhost:8787 using Chromium. 

* username: rstudio password: rstudio

* `coursematerial` contains the data and plotting functions we will use.

* `codeExample.R` shows how to use the plotting functions.


## Interactive exercises

* The `coursematerial` folder is a git repository
* Solutions are stored as tagged commits for code in the `worked_example` directory
    * These are coloured red in the slides

```
git checkout helloworld
```
From the rstudio console will checkout the solution.

Make your own Shiny app in another directory


## Anatomy of a Shiny App - user interface

```
ui <- fluidPage(
    
    # Application title
    titlePanel("Old Faithful Geyser Data"),
    
    # Sidebar with a slider input for number of bins 
    sidebarLayout(
        sidebarPanel(
            sliderInput("bins", ...
        ),
        
        
        mainPanel(
           plotOutput("distPlot")
        )
    )
)
```

`input$bins` is a source

`output$distPlot` is an endpoint

## Anatomy of a Shiny App - server
```
server <- function(input, output) {
    
    output$distPlot <- renderPlot({
        # generate bins based on input$bins from ui.R
        x    <- faithful[, 2] 
        bins <- seq(min(x), max(x), length.out = input$bins + 1)
        
        # draw the histogram with the specified number of bins
        hist(x, breaks = bins, col = 'darkgray', border = 'white')
    })
}

```

## Exercise 

* Create and save a new Shiny app (this will be pre-filled with the example code) <span style="color:red">helloworld</span>
* Check this works
* Modify the app to load the ggplot2 and dplyr libraries, gapminder data and `plottingFunctions.R` <span style="color:red">loadresources</span>
* Modify the app to plot a histogram of all the populations in the gapminder data <span style="color:red">histogram</span>

## Exercise: Workshop aims

- To use Shiny to make an interactive version of the plot
    - Select / animate the year
    - ~~Only plot data for selected continents~~
    - ~~Customise the look of our app~~
    - ~~Identify a country by selecting it~~
    - ~~Show "trajectory" for selected country~~

## Exercises

- Create a new `sliderInput` with `inputId` "year" to select a year. <span style="color:red">yearslider</span>
- use the `animate` option to allow this to run through the years <span style="color:red">animate</span>
    - You may wish to explore `animationOptions()` to control the animation speed
    
- Using the code in `codeExample.R` as a starting point,  plot the data for the selected year in the app
    - Delete the `bins` slider as it is no longer being used. <span style="color:red">baseplot</span>


## More widgets

- Many common widget types are built into Shiny see:
    https://shiny.rstudio.com/gallery/widget-gallery.html 
- Can be extended using additional packages (https://github.com/dreamRs/shinyWidgets)
- or by writing your own.
  

## Exercise: Workshop aims

- To use Shiny to make an interactive version of the plot
    - ~~Select / animate the year~~
    - Only plot data for selected continents
    - ~~Customise the look of our app~~
    - ~~Identify a country by selecting it~~
    - ~~Show "trajectory" for selected country~~

- Add another widget to select continents <span style="color:red">continentUI</span>
- Modify your server function to filter the data so that only the selected continents are shown.<span style="color:red">continent</span>

## Cutomising how our app looks

- The `shinythemes` package lets us select readymade themes for our app
- Can write our own css for more control
- `shinythemes::themeSelector()` widget lets us interactively exeriment with themes <span style="color:red">themeselector</span>
- Use the option `theme = shinytheme("themename")` on your user interface function (`fluidPage`) in our example <span style="color:red">changetheme</span>

    
## App layout

- The default apps `sidebarLayout()` is a good starting point.
- The `fluidPage()` layout gives us more control.

```{r, echo = TRUE,  eval = FALSE}
ui <- fluidPage(
  titlePanel("Gapminder Analysis"), # Will cover whole width
  plotOutput("mainPlot", click = "mainPlotClick"), # Ditto
  fluidRow( 
    column(6, # column width
           sliderInput(inputId = "year", ....) # Things to include in the column
    ),
    column(6, # Next column
           checkboxGroupInput("continent", ....)# Things to include in second column
    )
  )
)
```

- The widths of each row of columns should sum to 12 <span style="color:red">fluidpage</span>


## Making the graph interactive
- To use Shiny to make an interactive version of the plot
    - ~~Select / animate the year~~
    - ~~Only plot data for selected continents~~
    - ~~Customise the look of our app~~
    - Identify a country by selecting it
    - ~~Show "trajectory" for selected country~~

##

- `plotOutput("plotname", click = "clickName")` will output information about mouse clicks within a plot to the server.
- To see the output of this we need to use `renderPrint()` to capture the output
- Which we then need to display in our user interface using `textOutput()`
<span style="color:red">clickdata</span>

## Working with click data

- Click output is in mapped coordinates (dependent on graph package)
- Need to map coordinates to an entry in the data - `nearPoints()` does this for us
  - We can look at the output of `nearPoints()` (optionally using `renderTable()` and `tableOutput()` to format things nicely)
<span style="color:red">nearpoints</span>

## Working with click data

2 problems:

1. `nearPoints()` is using _all_ the data, not just the current year
    - Should be the data displayed on the graph
2. As soon as the graph changes...the click event is lost
    - Year advances
    - Graph resizes

## Solving problem 1

- We make the filtered data _reactive_   <span style="color:red">reactivedata</span>
    - Data which changes over time

## Reactive data

```{r}
edges <- tribble(~v1, ~v2,
                 "year", "plotData",
                 "continent", "plotData",
                 "plotData", "lifeExpPlot",
                 "plotClick", "showClick",
                 "plotData", "showClick")



g <- graph_from_edgelist(as.matrix(edges)) %>% 
set_vertex_attr( "color", value = "red", index = c("year", "continent", "plotClick")) %>% 
  set_vertex_attr( "color", value = "green", index = c("plotData")) %>% 
  set_vertex_attr("color", value = "yellow", index = c("lifeExpPlot", "showClick")) 

layout <- structure(c(148, 200, 281, 121, 400, 287, 386, 200, 386, 4, 382, 
0), .Dim = c(6L, 2L))

plot(g, layout = layout)

```

## Solving problem 2

- The `plotClick` is lost every time the graph updates
- We use `observeEvent()` to observe when a click happens
- And only then do we update the active country <span style="color:red">showselected</span>

##

```{r}
edges2 <- tribble(~v1, ~v2,
                 "year", "plotData",
                 "continent", "plotData",
                 "year", "historicData",
                 "activeCountry", "historicData",
                 "plotData", "lifeExpPlot",
                 # "historicData", "lifeExpPlot",
                 "activeCountry", "showClick",
                 "plotClick", "activeCountry"
                 )



g2 <- graph_from_edgelist(as.matrix(edges2)) %>% 
set_vertex_attr( "color", value = "red", index = c("year", "continent", "plotClick")) %>% 
  set_vertex_attr( "color", value = "green", index = c("plotData", "historicData", "activeCountry")) %>% 
  set_vertex_attr("color", value = "yellow", index = c("lifeExpPlot", "showClick")) 

layout2 <- structure(c(83, 117, 244, 247, 353, 77, 378, 381, 364, 170, 368, 
171, 246, 0, 5, 371), .Dim = c(8L, 2L))

plot(g2, layout = layout2)
```

##

```{r}
g2 %>% add_edges(c("historicData", "lifeExpPlot",
                   "year", "lifeExpPlot")) %>% 
  plot(layout=layout2)
```


## Exercise: Workshop aims

- To use Shiny to make an interactive version of the plot
    - ~~Select / animate the year~~
    - ~~Only plot data for selected continents~~
    - ~~Customise the look of our app~~
    - ~~Identify a country by selecting it~~
    - Show "trajectory" for selected country
    

- Complete the app by modifying `output$lifeExpPlot` to add the historic data if `!is.na( activeCountry() )`
<span style="color:red">showtrace</span>


## Deploying Shiny apps

- Run from R(Studio)

- https://shinyapps.io easy deployment from RStudioo
    - Various pricing tiers 
    - https://mawds.shinyapps.io/worked_example/
- Local Shiny server
    - Free and commercial versions
    - Authentication requires commercial version
    
